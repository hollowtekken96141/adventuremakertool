<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Maker (Static Version)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background-color: #333;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .container {
            display: flex;
            flex: 1;
        }
        
        .controls {
            width: 250px;
            padding: 10px;
            background-color: #ddd;
            overflow-y: auto;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
        }
        
        .editor {
            width: 375px;
            height: 667px;
            background-color: white;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .clickable-area {
            position: absolute;
            border: 2px dashed red;
            background-color: rgba(255, 0, 0, 0.1);
            cursor: move;
        }
        
        .clickable-area button {
            position: absolute;
            top: 0;
            background: white;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        
        .clickable-area .edit-button {
            right: 25px;
            font-size: 12px;
        }
        
        .clickable-area .edit-button::before {
            content: "ðŸ”—";
            margin-right: 3px;
        }
        
        .clickable-area .delete-button {
            right: 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-buttons {
            margin-top: 15px;
            text-align: right;
        }
        
        .modal-buttons button {
            display: inline-block;
            width: auto;
            margin-left: 10px;
        }
        
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: red;
            cursor: se-resize;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
        }
        
        input, select, button {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Adventure Maker (Static Version)</h1>
    </div>
    
    <div class="container">
        <div class="controls">
            <div class="form-group">
                <label for="scene-selector">Current Scene:</label>
                <select id="scene-selector"></select>
            </div>
            
            <button id="add-scene-button">Add Scene</button>
            <button id="delete-scene-button">Delete Scene</button>
            <button id="rename-scene-button">Rename Scene</button>
            
            <div class="form-group">
                <label for="upload-gif">Upload Background GIF:</label>
                <input type="file" id="upload-gif" accept="image/gif">
            </div>
            
            <div class="form-group">
                <label for="background-mode">Background Display Mode:</label>
                <select id="background-mode">
                    <option value="cover">Stretch to Fit</option>
                    <option value="repeat">Tiled</option>
                    <option value="auto">Normal</option>
                </select>
            </div>
            
            <button id="add-clickable-area">Add Clickable Area</button>
            <button id="export-game-button">Export Game</button>
            <button id="clear-storage-button">Clear All Data</button>
        </div>
        
        <div class="editor-container">
            <div class="editor" id="editor"></div>
        </div>
    </div>

    <script>
        // Global variables
        let scenes = { "1": { gif: '', areas: [], backgroundMode: 'cover' } };
        let currentScene = "1";
        
        // DOM elements
        const sceneSelector = document.getElementById('scene-selector');
        const editor = document.getElementById('editor');
        
        // LocalStorage key
        const STORAGE_KEY = 'adventure_maker_scenes';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadScenesFromStorage();
            updateSceneSelector();
            displayScene(currentScene);
            setupEventListeners();
        });
        
        // Load scenes from localStorage
        function loadScenesFromStorage() {
            const storedScenes = localStorage.getItem(STORAGE_KEY);
            if (storedScenes) {
                try {
                    scenes = JSON.parse(storedScenes);
                    console.log('Loaded scenes from localStorage:', scenes);
                } catch (error) {
                    console.error('Error parsing scenes from localStorage:', error);
                }
            }
            
            // Ensure we have at least one scene
            if (Object.keys(scenes).length === 0) {
                scenes = { "1": { gif: '', areas: [] } };
            }
        }
        
        // Save scenes to localStorage
        function saveScenesToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(scenes));
            console.log('Saved scenes to localStorage');
        }
        
        // Update the scene selector dropdown
        function updateSceneSelector() {
            sceneSelector.innerHTML = '';
            for (const sceneName in scenes) {
                const option = document.createElement('option');
                option.value = sceneName;
                option.textContent = sceneName;
                sceneSelector.appendChild(option);
            }
            sceneSelector.value = currentScene;
        }
        
        // Display the current scene
        function displayScene(sceneName) {
            const scene = scenes[sceneName];
            editor.innerHTML = '';
            
            if (scene) {
                // Set background image if available
                if (scene.gif) {
                    editor.style.backgroundImage = "url('" + scene.gif + "')";
                    
                    // Apply background mode
                    const backgroundMode = scene.backgroundMode || 'cover';
                    
                    // Set appropriate background properties based on mode
                    if (backgroundMode === 'cover') {
                        editor.style.backgroundSize = 'cover';
                        editor.style.backgroundPosition = 'center';
                        editor.style.backgroundRepeat = 'no-repeat';
                    } else if (backgroundMode === 'repeat') {
                        editor.style.backgroundSize = 'auto';
                        editor.style.backgroundPosition = '0 0';
                        editor.style.backgroundRepeat = 'repeat';
                    } else if (backgroundMode === 'auto') {
                        editor.style.backgroundSize = 'auto';
                        editor.style.backgroundPosition = 'center';
                        editor.style.backgroundRepeat = 'no-repeat';
                    }
                    
                    // Update background mode dropdown
                    const backgroundModeSelect = document.getElementById('background-mode');
                    if (backgroundModeSelect) {
                        backgroundModeSelect.value = backgroundMode;
                    }
                } else {
                    editor.style.backgroundImage = 'none';
                }
                
                // Create clickable areas
                if (scene.areas && Array.isArray(scene.areas)) {
                    scene.areas.forEach(areaData => {
                        createClickableArea(areaData);
                    });
                }
            }
        }
        
        // Create a clickable area in the editor
        function createClickableArea(areaData) {
            const area = document.createElement('div');
            area.classList.add('clickable-area');
            area.style.top = areaData.top || '10%';
            area.style.left = areaData.left || '10%';
            area.style.width = areaData.width || '100px';
            area.style.height = areaData.height || '100px';
            area.dataset.target = areaData.target || '';
            area.dataset.targetType = areaData.targetType || 'scene';
            
            // Add edit button
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.classList.add('edit-button');
            area.appendChild(editButton);
            
            // Add delete button
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'X';
            deleteButton.classList.add('delete-button');
            area.appendChild(deleteButton);
            
            // Add resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.classList.add('resize-handle');
            area.appendChild(resizeHandle);
            
            // Add drag functionality
            area.addEventListener('mousedown', startDrag);
            
            // Add resize functionality
            resizeHandle.addEventListener('mousedown', startResize);
            
            // Add button event listeners
            editButton.addEventListener('click', function(e) {
                e.stopPropagation();
                editClickableArea(area);
            });
            
            deleteButton.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteClickableArea(area);
            });
            
            editor.appendChild(area);
            return area;
        }
        
        // Add a new scene
        function addScene() {
            const sceneName = prompt("Enter new scene name:");
            if (sceneName && !scenes[sceneName]) {
                scenes[sceneName] = { gif: '', areas: [], backgroundMode: 'cover' };
                updateSceneSelector();
                currentScene = sceneName;
                sceneSelector.value = sceneName;
                displayScene(sceneName);
                saveScenesToStorage();
            } else if (scenes[sceneName]) {
                alert("Scene name already exists.");
            }
        }
        
        // Delete the current scene
        function deleteScene() {
            if (Object.keys(scenes).length <= 1) {
                alert("Cannot delete the only scene.");
                return;
            }
            
            if (confirm("Are you sure you want to delete scene \"" + currentScene + "\"?")) {
                delete scenes[currentScene];
                currentScene = Object.keys(scenes)[0];
                updateSceneSelector();
                displayScene(currentScene);
                saveScenesToStorage();
            }
        }
        
        // Rename the current scene
        function renameScene() {
            const newName = prompt("Enter new scene name:", currentScene);
            if (newName && !scenes[newName] && newName !== currentScene) {
                scenes[newName] = scenes[currentScene];
                delete scenes[currentScene];
                currentScene = newName;
                updateSceneSelector();
                saveScenesToStorage();
            } else if (scenes[newName]) {
                alert("Scene name already exists.");
            }
        }
        
        // Add a new clickable area to the current scene
        function addClickableArea() {
            const areaData = {
                top: '10%',
                left: '10%',
                width: '100px',
                height: '100px',
                target: '',
                targetType: 'scene'
            };
            
            const area = createClickableArea(areaData);
            scenes[currentScene].areas.push(areaData);
            saveScenesToStorage();
        }
        
        // Upload a GIF for the current scene
        function uploadGif(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size - limit to 2MB to be safe with localStorage limits
                const maxSizeInBytes = 2 * 1024 * 1024; // 2MB
                if (file.size > maxSizeInBytes) {
                    alert(`File is too large (${(file.size / (1024 * 1024)).toFixed(2)}MB). Maximum size is 2MB. Please choose a smaller GIF.`);
                    // Reset the file input
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        scenes[currentScene].gif = e.target.result;
                        displayScene(currentScene);
                        saveScenesToStorage();
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            alert('Storage quota exceeded. The GIF might still be too large or you have too many scenes stored. Try using a smaller GIF or clearing some data.');
                        } else {
                            alert('Error saving the GIF: ' + error.message);
                        }
                        // Reset the scene's GIF to avoid partial updates
                        displayScene(currentScene);
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Export the game as a standalone HTML file
        function exportGame() {
            const title = prompt("Enter a title for your game:", "My Adventure Game");
            if (!title) return;
            
            // Create a simple HTML file with the game content
            const gameData = JSON.stringify(scenes);
            
            // Create the HTML content
            const doc = document.implementation.createHTMLDocument(title);
            
            // Set up the head
            const meta = document.createElement('meta');
            meta.setAttribute('charset', 'UTF-8');
            doc.head.appendChild(meta);
            
            const viewport = document.createElement('meta');
            viewport.setAttribute('name', 'viewport');
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            doc.head.appendChild(viewport);
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                body {
                    margin: 0;
                    padding: 0;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    background-color: #000;
                }
                
                .game-container {
                    width: 375px;
                    height: 667px;
                    position: relative;
                    background-color: white;
                    overflow: hidden;
                }
                
                .clickable-area {
                    position: absolute;
                    cursor: pointer;
                }
            `;
            doc.head.appendChild(style);
            
            // Set up the body
            const container = document.createElement('div');
            container.className = 'game-container';
            container.id = 'game-container';
            doc.body.appendChild(container);
            
            // Add the script
            const script = document.createElement('script');
            script.textContent = `
                // Game data
                const scenes = ${gameData};
                let currentScene = "1";
                
                // Initialize the game
                document.addEventListener("DOMContentLoaded", function() {
                    displayScene(currentScene);
                });
                
                // Display a scene
                function displayScene(sceneName) {
                    const container = document.getElementById("game-container");
                    container.innerHTML = "";
                    
                    const scene = scenes[sceneName];
                    if (!scene) return;
                    
                    // Set background
                    if (scene.gif) {
                        container.style.backgroundImage = "url('" + scene.gif + "')";
                        
                        // Apply background mode
                        const backgroundMode = scene.backgroundMode || 'cover';
                        
                        // Set appropriate background properties based on mode
                        if (backgroundMode === 'cover') {
                            container.style.backgroundSize = 'cover';
                            container.style.backgroundPosition = 'center';
                            container.style.backgroundRepeat = 'no-repeat';
                        } else if (backgroundMode === 'repeat') {
                            container.style.backgroundSize = 'auto';
                            container.style.backgroundPosition = '0 0';
                            container.style.backgroundRepeat = 'repeat';
                        } else if (backgroundMode === 'auto') {
                            container.style.backgroundSize = 'auto';
                            container.style.backgroundPosition = 'center';
                            container.style.backgroundRepeat = 'no-repeat';
                        }
                    } else {
                        container.style.backgroundImage = "none";
                    }
                    
                    // Create clickable areas
                    if (scene.areas && Array.isArray(scene.areas)) {
                        scene.areas.forEach(function(area) {
                            const areaElement = document.createElement("div");
                            areaElement.classList.add("clickable-area");
                            areaElement.style.top = area.top;
                            areaElement.style.left = area.left;
                            areaElement.style.width = area.width;
                            areaElement.style.height = area.height;
                            
                            areaElement.addEventListener("click", function() {
                                if (area.targetType === "scene" && area.target) {
                                    displayScene(area.target);
                                } else if (area.targetType === "external" && area.target) {
                                    const target = area.openInNewTab ? "_blank" : "_self";
                                    window.open(area.target, target);
                                }
                            });
                            
                            container.appendChild(areaElement);
                        });
                    }
                }
            `;
            doc.body.appendChild(script);
            
            // Get the HTML content
            const html = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
            
            // Create a download link for the HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = title.replace(/\s+/g, '-').toLowerCase() + '.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Clear all data from localStorage
        function clearStorage() {
            if (confirm("Are you sure you want to clear all data? This cannot be undone.")) {
                localStorage.removeItem(STORAGE_KEY);
                scenes = { "1": { gif: '', areas: [] } };
                currentScene = "1";
                updateSceneSelector();
                displayScene(currentScene);
            }
        }
        
        // Drag functionality
        let dragTarget = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        function startDrag(e) {
            // Ignore if clicking on buttons or resize handle
            if (e.target !== this) return;
            
            dragTarget = this;
            dragOffsetX = e.clientX - this.getBoundingClientRect().left;
            dragOffsetY = e.clientY - this.getBoundingClientRect().top;
            
            // Add global event listeners
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            // Prevent default to avoid text selection during drag
            e.preventDefault();
        }
        
        function drag(e) {
            if (!dragTarget) return;
            
            const editorRect = editor.getBoundingClientRect();
            
            // Calculate new position relative to the editor
            let newLeft = e.clientX - editorRect.left - dragOffsetX;
            let newTop = e.clientY - editorRect.top - dragOffsetY;
            
            // Constrain to editor boundaries
            newLeft = Math.max(0, Math.min(newLeft, editorRect.width - dragTarget.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, editorRect.height - dragTarget.offsetHeight));
            
            // Update position
            dragTarget.style.left = newLeft + 'px';
            dragTarget.style.top = newTop + 'px';
            
            // Update the area data in the scenes object
            updateAreaPosition(dragTarget);
        }
        
        function stopDrag() {
            if (dragTarget) {
                // Save the final position
                saveScenesToStorage();
                dragTarget = null;
            }
            
            // Remove global event listeners
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        // Resize functionality
        let resizeTarget = null;
        
        function startResize(e) {
            resizeTarget = this.parentElement;
            
            // Add global event listeners
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            
            // Prevent default to avoid text selection during resize
            e.preventDefault();
        }
        
        function resize(e) {
            if (!resizeTarget) return;
            
            const editorRect = editor.getBoundingClientRect();
            const areaRect = resizeTarget.getBoundingClientRect();
            
            // Calculate new dimensions
            let newWidth = e.clientX - areaRect.left;
            let newHeight = e.clientY - areaRect.top;
            
            // Constrain to editor and minimum size
            newWidth = Math.max(50, Math.min(newWidth, editorRect.right - areaRect.left));
            newHeight = Math.max(50, Math.min(newHeight, editorRect.bottom - areaRect.top));
            
            // Update dimensions
            resizeTarget.style.width = newWidth + 'px';
            resizeTarget.style.height = newHeight + 'px';
            
            // Update the area data in the scenes object
            updateAreaDimensions(resizeTarget);
        }
        
        function stopResize() {
            if (resizeTarget) {
                // Save the final dimensions
                saveScenesToStorage();
                resizeTarget = null;
            }
            
            // Remove global event listeners
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
        
        // Update area data in the scenes object
        function updateAreaPosition(areaElement) {
            const areaIndex = findAreaIndex(areaElement);
            if (areaIndex !== -1) {
                scenes[currentScene].areas[areaIndex].left = areaElement.style.left;
                scenes[currentScene].areas[areaIndex].top = areaElement.style.top;
            }
        }
        
        function updateAreaDimensions(areaElement) {
            const areaIndex = findAreaIndex(areaElement);
            if (areaIndex !== -1) {
                scenes[currentScene].areas[areaIndex].width = areaElement.style.width;
                scenes[currentScene].areas[areaIndex].height = areaElement.style.height;
            }
        }
        
        function findAreaIndex(areaElement) {
            const areas = editor.querySelectorAll('.clickable-area');
            for (let i = 0; i < areas.length; i++) {
                if (areas[i] === areaElement) {
                    return i;
                }
            }
            return -1;
        }
        
        // Create modal for editing clickable area
        function createEditModal() {
            // Check if modal already exists
            if (document.getElementById('edit-area-modal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'edit-area-modal';
            modal.className = 'modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            const heading = document.createElement('h3');
            heading.textContent = 'Edit Clickable Area';
            modalContent.appendChild(heading);
            
            // Target type selection
            const typeGroup = document.createElement('div');
            typeGroup.className = 'form-group';
            
            const typeLabel = document.createElement('label');
            typeLabel.setAttribute('for', 'target-type');
            typeLabel.textContent = 'Target Type:';
            typeGroup.appendChild(typeLabel);
            
            const typeSelect = document.createElement('select');
            typeSelect.id = 'target-type';
            
            const sceneOption = document.createElement('option');
            sceneOption.value = 'scene';
            sceneOption.textContent = 'Scene';
            typeSelect.appendChild(sceneOption);
            
            const externalOption = document.createElement('option');
            externalOption.value = 'external';
            externalOption.textContent = 'External Link';
            typeSelect.appendChild(externalOption);
            
            // Add change event to toggle between scene select and URL input
            typeSelect.addEventListener('change', function() {
                toggleTargetInputs(this.value);
            });
            
            typeGroup.appendChild(typeSelect);
            modalContent.appendChild(typeGroup);
            
            // Target inputs container
            const targetGroup = document.createElement('div');
            targetGroup.className = 'form-group';
            
            const targetLabel = document.createElement('label');
            targetLabel.id = 'target-label';
            targetLabel.textContent = 'Target Scene:';
            targetGroup.appendChild(targetLabel);
            
            // Scene select dropdown
            const sceneSelect = document.createElement('select');
            sceneSelect.id = 'scene-target-select';
            sceneSelect.className = 'target-input';
            targetGroup.appendChild(sceneSelect);
            
            // External URL input
            const urlInput = document.createElement('input');
            urlInput.id = 'external-target-input';
            urlInput.className = 'target-input';
            urlInput.type = 'text';
            urlInput.placeholder = 'Enter URL (e.g., https://example.com)';
            urlInput.style.display = 'none';
            targetGroup.appendChild(urlInput);
            
            // New tab option (only visible when external link is selected)
            const newTabGroup = document.createElement('div');
            newTabGroup.className = 'form-group';
            newTabGroup.id = 'new-tab-group';
            newTabGroup.style.display = 'none';
            
            const newTabCheckboxContainer = document.createElement('div');
            newTabCheckboxContainer.style.display = 'flex';
            newTabCheckboxContainer.style.alignItems = 'center';
            
            const newTabCheckbox = document.createElement('input');
            newTabCheckbox.type = 'checkbox';
            newTabCheckbox.id = 'new-tab-checkbox';
            newTabCheckbox.style.width = 'auto';
            newTabCheckbox.style.marginRight = '10px';
            newTabCheckboxContainer.appendChild(newTabCheckbox);
            
            const newTabLabel = document.createElement('label');
            newTabLabel.setAttribute('for', 'new-tab-checkbox');
            newTabLabel.textContent = 'Open in new tab';
            newTabLabel.style.display = 'inline';
            newTabLabel.style.marginBottom = '0';
            newTabCheckboxContainer.appendChild(newTabLabel);
            
            newTabGroup.appendChild(newTabCheckboxContainer);
            targetGroup.appendChild(newTabGroup);
            
            modalContent.appendChild(targetGroup);
            
            // Buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'modal-buttons';
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.style.backgroundColor = '#f44336';
            cancelButton.onclick = function() {
                modal.style.display = 'none';
            };
            
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.onclick = function() {
                const areaIndex = parseInt(modal.dataset.areaIndex);
                
                if (areaIndex === -1) {
                    modal.style.display = 'none';
                    return;
                }
                
                const targetType = typeSelect.value;
                let target = '';
                let openInNewTab = false;
                
                if (targetType === 'scene') {
                    target = sceneSelect.value;
                } else {
                    target = urlInput.value;
                    openInNewTab = document.getElementById('new-tab-checkbox').checked;
                }
                
                // Update the area data
                scenes[currentScene].areas[areaIndex].targetType = targetType;
                scenes[currentScene].areas[areaIndex].target = target;
                scenes[currentScene].areas[areaIndex].openInNewTab = openInNewTab;
                
                // Update the element's dataset
                document.querySelectorAll('.clickable-area')[areaIndex].dataset.targetType = targetType;
                document.querySelectorAll('.clickable-area')[areaIndex].dataset.target = target;
                
                saveScenesToStorage();
                modal.style.display = 'none';
            };
            
            buttonsDiv.appendChild(cancelButton);
            buttonsDiv.appendChild(saveButton);
            modalContent.appendChild(buttonsDiv);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Function to toggle between scene select and URL input
            function toggleTargetInputs(targetType) {
                const sceneSelect = document.getElementById('scene-target-select');
                const urlInput = document.getElementById('external-target-input');
                const targetLabel = document.getElementById('target-label');
                const newTabGroup = document.getElementById('new-tab-group');
                
                if (targetType === 'scene') {
                    sceneSelect.style.display = 'block';
                    urlInput.style.display = 'none';
                    newTabGroup.style.display = 'none';
                    targetLabel.textContent = 'Target Scene:';
                } else {
                    sceneSelect.style.display = 'none';
                    urlInput.style.display = 'block';
                    newTabGroup.style.display = 'block';
                    targetLabel.textContent = 'Target URL:';
                }
            }
        }
        
        // Populate scene select dropdown
        function populateSceneSelect(selectElement, currentValue) {
            selectElement.innerHTML = '';
            
            // Add an empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- Select a scene --';
            selectElement.appendChild(emptyOption);
            
            // Add all available scenes
            for (const sceneName in scenes) {
                const option = document.createElement('option');
                option.value = sceneName;
                option.textContent = sceneName;
                selectElement.appendChild(option);
            }
            
            // Set current value if provided
            if (currentValue) {
                selectElement.value = currentValue;
            }
        }
        
        // Edit clickable area
        function editClickableArea(areaElement) {
            const areaIndex = findAreaIndex(areaElement);
            if (areaIndex === -1) return;
            
            const areaData = scenes[currentScene].areas[areaIndex];
            
            // Create modal if it doesn't exist
            createEditModal();
            
            const modal = document.getElementById('edit-area-modal');
            const typeSelect = document.getElementById('target-type');
            const sceneSelect = document.getElementById('scene-target-select');
            const urlInput = document.getElementById('external-target-input');
            
            // Populate scene select dropdown
            populateSceneSelect(sceneSelect, areaData.targetType === 'scene' ? areaData.target : '');
            
            // Set current values
            typeSelect.value = areaData.targetType || 'scene';
            
            if (areaData.targetType === 'external') {
                urlInput.value = areaData.target || '';
                document.getElementById('new-tab-checkbox').checked = areaData.openInNewTab || false;
            }
            
            // Toggle input display based on target type
            toggleTargetInputs(areaData.targetType || 'scene');
            
            // Store reference to area
            modal.dataset.areaIndex = areaIndex;
            
            // Show modal
            modal.style.display = 'block';
            
            // Function to toggle between scene select and URL input
            function toggleTargetInputs(targetType) {
                if (targetType === 'scene') {
                    sceneSelect.style.display = 'block';
                    urlInput.style.display = 'none';
                    document.getElementById('new-tab-group').style.display = 'none';
                    document.getElementById('target-label').textContent = 'Target Scene:';
                } else {
                    sceneSelect.style.display = 'none';
                    urlInput.style.display = 'block';
                    document.getElementById('new-tab-group').style.display = 'block';
                    document.getElementById('target-label').textContent = 'Target URL:';
                }
            }
        }
        
        // Delete clickable area
        function deleteClickableArea(areaElement) {
            const areaIndex = findAreaIndex(areaElement);
            if (areaIndex === -1) return;
            
            if (confirm("Are you sure you want to delete this clickable area?")) {
                // Remove from DOM
                areaElement.remove();
                
                // Remove from data
                scenes[currentScene].areas.splice(areaIndex, 1);
                saveScenesToStorage();
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Scene selector change
            sceneSelector.addEventListener('change', function() {
                currentScene = this.value;
                displayScene(currentScene);
            });
            
            // Background mode change
            document.getElementById('background-mode').addEventListener('change', function() {
                if (scenes[currentScene]) {
                    scenes[currentScene].backgroundMode = this.value;
                    displayScene(currentScene);
                    saveScenesToStorage();
                }
            });
            
            // Add scene button
            document.getElementById('add-scene-button').addEventListener('click', addScene);
            
            // Delete scene button
            document.getElementById('delete-scene-button').addEventListener('click', deleteScene);
            
            // Rename scene button
            document.getElementById('rename-scene-button').addEventListener('click', renameScene);
            
            // Upload GIF
            document.getElementById('upload-gif').addEventListener('change', uploadGif);
            
            // Add clickable area
            document.getElementById('add-clickable-area').addEventListener('click', addClickableArea);
            
            // Export game
            document.getElementById('export-game-button').addEventListener('click', exportGame);
            
            // Clear storage
            document.getElementById('clear-storage-button').addEventListener('click', clearStorage);
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('edit-area-modal');
                if (modal && event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
